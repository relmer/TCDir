name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build-and-test:
    runs-on: windows-latest
    strategy:
      matrix:
        configuration: [Debug, Release]
        platform: [x64]
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Add MSBuild to PATH
        uses: microsoft/setup-msbuild@v2

      - name: Setup VSTest
        uses: darenm/Setup-VSTest@v1.3

      - name: Build
        run: msbuild TCDir.sln -p:Configuration=${{ matrix.configuration }} -p:Platform=${{ matrix.platform }} -p:PlatformToolset=v143 -p:PostBuildEventUseInBuild=false

      - name: Run Tests
        run: vstest.console.exe ${{ matrix.platform }}/${{ matrix.configuration }}/UnitTest.dll

  build-arm64:
    runs-on: windows-latest
    strategy:
      matrix:
        configuration: [Debug, Release]
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Add MSBuild to PATH
        uses: microsoft/setup-msbuild@v2

      - name: Build ARM64
        run: msbuild TCDir.sln -p:Configuration=${{ matrix.configuration }} -p:Platform=ARM64 -p:PlatformToolset=v143 -p:PostBuildEventUseInBuild=false

      - name: Upload ARM64 Binaries
        uses: actions/upload-artifact@v4
        if: matrix.configuration == 'Release'
        with:
          name: tcdir-arm64-${{ matrix.configuration }}
          path: ARM64/${{ matrix.configuration }}/TCDir.exe
          retention-days: 30
